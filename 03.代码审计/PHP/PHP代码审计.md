---
title: PHPä»£ç å®¡è®¡
date: 2023/5/31 19:48:25
categories:
- PHP
tags:
- ä»£ç å®¡è®¡
---

- [x] BlueCMS

- [x] SeaCMS

- [x] DedeCMS

- [x] ThinkPHP

  

# è°ƒè¯•

https://blog.csdn.net/Xxy605/article/details/120973447



# æ€è·¯

From https://www.anquanke.com/post/id/265092#h3-5

- å‡½æ•°é›†æ–‡ä»¶ï¼Œé€šå¸¸å‘½ååŒ…å«functionæˆ–è€…commonç­‰å…³é”®å­—ï¼Œè¿™äº›æ–‡ä»¶é‡Œé¢æ˜¯ä¸€äº›å…¬å…±çš„å‡½æ•°ï¼Œæä¾›å…¶ä»–æ–‡ä»¶ç»Ÿä¸€è°ƒç”¨ï¼Œæ‰€ä»¥å¤§å¤šæ•°æ–‡ä»¶éƒ½ä¼šåœ¨æ–‡ä»¶å¤´éƒ¨åŒ…å«åˆ°å…¶ä»–æ–‡ä»¶ã€‚å¯»æ‰¾è¿™äº›æ–‡ä»¶ä¸€ä¸ªéå¸¸å¥½ç”¨çš„æŠ€å·§å°±æ˜¯å»æ‰“å¼€index.phpæˆ–è€…ä¸€äº›åŠŸèƒ½æ€§æ–‡ä»¶ï¼Œåœ¨å¤´éƒ¨ä¸€èˆ¬éƒ½èƒ½æ‰¾åˆ°ã€‚
- é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸å‘½åä¸­åŒ…æ‹¬configå…³é”®å­—ï¼Œé…ç½®æ–‡ä»¶åŒ…æ‹¬webç¨‹åºè¿è¡Œå¿…é¡»çš„åŠŸèƒ½æ€§é…ç½®é€‰é¡¹ä»¥åŠæ•°æ®åº“ç­‰é…ç½®ä¿¡æ¯ã€‚ä»è¿™ä¸ªæ–‡ä»¶ä¸­å¯ä»¥äº†è§£ç¨‹åºçš„å°éƒ¨åˆ†åŠŸèƒ½ï¼Œå¦å¤–çœ‹è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™æ³¨æ„è§‚å¯Ÿé…ç½®æ–‡ä»¶ä¸­å‚æ•°å€¼æ˜¯å•å¼•å·è¿˜æ˜¯ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼Œå¦‚æœæ˜¯åŒå¼•å·å¯èƒ½å°±å­˜åœ¨ä»£ç æ‰§è¡Œçš„é—®é¢˜äº†ã€‚
- å®‰å…¨è¿‡æ»¤æ–‡ä»¶ï¼Œå®‰å…¨è¿‡æ»¤æ–‡ä»¶å¯¹ä»£ç å®¡è®¡è‡³å…³é‡è¦ï¼Œè¿™å…³ç³»åˆ°æˆ‘ä»¬æŒ–æ˜åˆ°çš„å¯ä»¥ç‚¹èƒ½å¦ç›´æ¥åˆ©ç”¨ï¼Œé€šå¸¸å‘½åä¸­å¸¦æœ‰filterã€safeã€checkç­‰å…³é”®å­—ï¼Œè¿™ç±»æ–‡ä»¶ä¸»è¦æ˜¯å¯¹å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼Œå¤§å¤šæ•°çš„åº”ç”¨å…¶å®ä¼šåœ¨å‚æ•°çš„è¾“å…¥åšä¸€ä¸‹addslashes()å‡½æ•°çš„è¿‡æ»¤ã€‚
- indexæ–‡ä»¶ï¼Œindexæ˜¯ä¸€ä¸ªç¨‹åºçš„å…¥å£ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬åªè¦è¯»ä¸€è¯»indexæ–‡ä»¶å°±å¯ä»¥å¤§è‡´äº†è§£æ•´ä¸ªç¨‹åºçš„æ¶æ„ã€è¿è¡Œçš„æµç¨‹ã€åŒ…å«åˆ°çš„æ–‡ä»¶ï¼Œå…¶ä¸­æ ¸å¿ƒçš„æ–‡ä»¶æœ‰å“ªäº›ã€‚è€Œä¸åŒç›®å½•çš„indexæ–‡ä»¶ä¹Ÿæœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå»ºè®®æœ€å¥½å°†å‡ ä¸ªæ ¸å¿ƒç›®å½•çš„indexæ–‡ä»¶éƒ½é€šè¯»ä¸€éã€‚



# æ€»ç»“å¤§è‡´æµç¨‹

**1ã€å…ˆå…¨å±€æ€»è§ˆï¼šå…¥å£æ–‡ä»¶ã€è·¯ç”±ã€å…¨å±€å¤„ç†æ–¹å¼ç­‰**
**2ã€å®šå‘åŠŸèƒ½å®¡è®¡ï¼šé»‘ç›’(æ‰¾åˆ°æ•æ„ŸåŠŸèƒ½)+ç™½ç›’ï¼ˆå®šä½åˆ°ä»£ç è¿›è¡Œå®¡è®¡ï¼‰**
**3ã€æ•æ„Ÿå‡½æ•°å›æº¯**

å…ˆé»‘ç›’+ç™½ç›’çœ‹æ•æ„ŸåŠŸèƒ½ï¼Œå†ç”¨è‡ªåŠ¨åŒ–å®¡è®¡å·¥å…·è·‘ä¸€éå¹¶éªŒè¯ï¼Œæœ€åå†æ ¹æ®æ¼æ´å±é™©å‡½æ•°å»å›æº¯



### è‡ªåŠ¨åŒ–å®¡è®¡å·¥å…·

RIPShttps://github.com/J0o1ey/rips-Chinese

seay

Fortify



# bluecms

## é»‘ç›’æµ‹è¯•

#### ç”¨æˆ·æ³¨å†Œ

åœ¨æ³¨å†Œæ—¶ï¼Œé‚®ç®±æ’å…¥xssä»£ç 

![image-20221202120912126](../../../images/image-20221202120912126-1686141975680.png)

![image-20221202120807928](../../../images/image-20221202120807928-1686141975682.png)

![image-20221202120844185](../../../images/image-20221202120844185-1686141975683.png)



#### ç”¨æˆ·å¤´åƒ

ä¸Šä¼ æ–‡ä»¶ï¼Œåªå…è®¸ä¸Šä¼ å›¾ç‰‡åç¼€çš„æ–‡ä»¶ï¼Œä¸Šä¼ åæœ‰ç»™å‡ºå›¾ç‰‡è·¯å¾„ï¼Œé‚£ä¹ˆä¸èƒ½é…åˆ.htaccessï¼Œéœ€è¦æ‰¾åˆ°ä¸€ä¸ªæ–‡ä»¶åŒ…å«çš„ç‚¹æ¥åŒ…å«æ–‡ä»¶ã€‚

![image-20221202120844185](../../../images/image-20221202121559453.png)





#### ä¿®æ”¹å¯†ç 

æ˜¯å¦å­˜åœ¨è¶Šæƒ,æµ‹è¯•äº†æ²¡æœ‰



#### å‘å¸ƒæ–°é—»

![image-20221202120844185](../../../images/image-20221202122851275.png)

è¿™é‡Œåˆ†ç±»é€‰æ‹©ä¸äº†ï¼Œåº”è¯¥æ˜¯è¦ç®¡ç†å‘˜å‘å¸ƒã€‚





#### ç›®å½•æ‰«æ

ç®¡ç†å‘˜

![image-20221202123640697](../../../images/image-20221202123640697-1686141975683.png)

å…¶ä»–

![image-20221202125147298](../../../images/image-20221202125147298-1686141975683.png)







#### åå°ç™»å½•

![image-20221202123831559](../../../images/image-20221202123831559-1686141975683.png)



è¿™é‡Œæ²¡æœ‰éªŒè¯ç éªŒè¯ï¼Œé‚£ä¹ˆå¯ä»¥å¾ˆè½»æ¾åœ°è¿›è¡Œçˆ†ç ´ï¼Œå¾—åˆ°usernmae=adminï¼Œpasswd=admin

![image-20221202120844185](../../../images/image-20221202124055555.png)



è¿›å»ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå»ºè®®ï¼Œinstallæ–‡ä»¶å¤¹ï¼Œä¸Šé¢é€šè¿‡dirsearchä¹Ÿæ‰«æå‡ºäº†è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶å¤¹æ¥é‡æ–°å®‰è£…ç½‘ç«™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é‡ç½®ç®¡ç†å‘˜äº†ï¼Œå¯æƒœæ˜¯ä¸å¯ä»¥çš„ã€‚

![image-20221202124235008](../../../images/image-20221202124235008-1686141975683.png)

#### å¸¸ç”¨æ“ä½œ

å‘å¸ƒæœ¬åœ°æ–°é—»è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ“ä½œï¼Œä½†æ˜¯ä¹Ÿåªèƒ½ä¸Šä¼ å›¾ç‰‡

![image-20221202175209000](../../../images/image-20221202175209000-1686141975683.png)

#### ä¼šå‘˜ç®¡ç†

å¯ä»¥å‘ç°è§¦å‘äº†ä¹‹å‰çš„xssï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æ²¡æœ‰ç™»é™†ä¸Šåå°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™ä¸ªxssæ¥ğŸ£è·å–ç®¡ç†å‘˜çš„cookieã€‚

![image-20221202124632258](../../../images/image-20221202124632258-1686141975683.png)

ä¹Ÿå¯ä»¥ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•éªŒè¯ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ã€‚ã€‚

![image-20221202175052927](../../../images/image-20221202175052927-1686141975686.png)





## ç™½ç›’å®¡è®¡

å…ˆçœ‹ä¸€ä¸‹ç›®å½•

![image-20221202155440394](../../../images/image-20221202155440394-1686141975685.png)

### å‰å°

å…ˆçœ‹ä¸€ä¸‹å‰å°çš„index.phpï¼Œå†…å®¹å·®ä¸å¤šå°±æ˜¯æ¸²æŸ“é¡µé¢ï¼Œæ²¡æœ‰ç”¨æˆ·å¯æ§çš„å‚æ•°ï¼Œæ‰€ä»¥å…³æ³¨å…¶åŒ…å«çš„å…¶ä»–æ–‡ä»¶ã€‚

![image-20221202135553953](../../../images/image-20221202135553953-1686141975686.png)



è·Ÿè¿›common.inc.phpçœ‹ä¸€ä¸‹

å…³é”®éƒ¨åˆ†ï¼Œç”¨æ¥éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå…¶ä¸­cookieä¸­çš„å‚æ•°æ˜¯å¯æ§çš„ã€‚

![image-20221202135942047](../../../images/image-20221202135942047-1686141975683.png)

å…ˆåˆ¤æ–­cookieä¸­æ˜¯å¦æœ‰user_idï¼Œæœ‰çš„è¯å†ç»§ç»­åˆ¤æ–­user_nameå’Œuser_pwdæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±check_cookieï¼Œå¦‚æœåªæœ‰user_nameå­˜åœ¨å°±æŸ¥è¯¢åå­—æ˜¯å¦åªæœ‰ä¸€ä¸ªï¼Œå…¶ä»–æƒ…å†µset_cookieã€‚

#### sqlæ³¨å…¥

è·Ÿè¿›check_cookie

![image-20221202140225964](../../../images/image-20221202140225964-1686141975683.png)

æŸ¥usernameå¯¹åº”çš„å¯†ç ï¼Œç»è¿‡æ•£åˆ—å¤„ç†åˆ¤æ–­å¯†ç æ˜¯å¦æ­£ç¡®ã€‚



è·Ÿè¿›getone--åœ¨include/mysql.class.phpä¸­

![image-20221202140336939](../../../images/image-20221202140336939-1686141975683.png)

![image-20221202140349680](../../../images/image-20221202140349680-1686141975683.png)

![image-20221202185616902](../../../images/image-20221202185616902-1686141975684.png)

å¯ä»¥çœ‹åˆ°æ²¡æœ‰å¯¹sqlè¯­å¥åšä»»ä½•å¤„ç†ï¼Œç›´æ¥ç”¨mysql_queryè¿›è¡ŒæŸ¥è¯¢ï¼Œsqlè¯­å¥é”™è¯¯æ—¶ï¼Œè¿”å›é”™è¯¯æ¶ˆæ¯Query errorï¼Œç„¶åæ˜¯å‰é¢åŠ äº†ä¸€ä¸ª@ï¼Œæ‰€ä»¥ä¸èƒ½ç”¨æŠ¥é”™æ³¨å…¥ã€‚





å†è§‚å¯Ÿinclude/mysql.class.phpå¯ä»¥å‘ç°

![image-20221202120844185](../../../images/image-20221202190550614.png)å‘ç°å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥ï¼Œé‚£ä¹ˆè¿™ä¸ªCMSå°±å¯ä»¥éšä¾¿æ³¨å…¥äº†ã€‚ã€‚ã€‚ï¼ˆå› ä¸ºæ‰€æœ‰çš„sqlæ“ä½œéƒ½æ˜¯ç”¨è¿™ä¸ªmysqlç±»ï¼‰



ä»¥ad_js.phpä¸ºä¾‹

![image-20221202120844185](../imaages/image-20221202190230473.png)

![image-20221202190707634](../../../images/image-20221202190707634-1686141975684.png)





#### æ–‡ä»¶åŒ…å«+æ–‡ä»¶ä¸Šä¼ 

è™½ç„¶æœ‰ç™½åå•é™åˆ¶ï¼Œåªèƒ½ä¸Šä¼ å›¾ç‰‡ï¼Œä½†æ˜¯æ²¡æœ‰å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œè¿‡æ»¤

![image-20221202171406255](../../../images/image-20221202171406255-1686141975684.png)

å¹¶ä¸”åœ¨user.phpä¸­ï¼Œæ²¡æœ‰å¯¹$_POST['pay']è¿›è¡Œè¿‡æ»¤ï¼Œå­˜åœ¨ç›®å½•ç©¿è¶Šï¼Œå°±å¯ä»¥åŒ…å«ä¸Šä¼ çš„ç”¨æˆ·å¤´åƒã€‚

![image-20221202185910243](../../../images/image-20221202185910243-1686141975684.png)



#### ä»»æ„æ–‡ä»¶åˆ é™¤

publish.php

![image-20221202190938927](../../../images/image-20221202190938927-1686141975684.png)

user.php

â€‹	![image-20221202194855624](../../../images/image-20221202194855624-1686141975684.png)

éœ€è¦å…ˆæ’å…¥ä¸€æ¡æ–°é—»ï¼Œæ–°é—»åä¸ºè¦åˆ é™¤çš„æ–‡ä»¶çš„è·¯å¾„ã€‚





### åå°--/admin

è¿˜æ˜¯å…ˆçœ‹ä¸€ä¸‹index.phpï¼Œä¹Ÿæ˜¯åªæ˜¯è¾“å‡ºäº†CMSå’Œç³»ç»Ÿçš„ä¸€äº›ä¿¡æ¯ï¼Œæ‰€ä»¥å…³æ³¨å…¶åŒ…å«çš„æ–‡ä»¶

![image-20221202191939851](../../../images/image-20221202191939851-1686141975684.png)

å…³é”®å†…å®¹

![image-20221202192232288](../../../images/image-20221202192232288-1686141975684.png)

å¯¹è¾“å…¥çš„å‚æ•°éƒ½ä½¿ç”¨addslashes()è¿›è¡Œè½¬ä¹‰,ä¸è¿‡è¿˜æœ‰`$SERVER`æ²¡æœ‰è¿›è¡Œå¤„ç†ã€‚

![image-20221202120844185](../../../images/image-20221202192459456.png)

â€‹	ä½¿ç”¨sessionæ¥éªŒè¯adminèº«ä»½ã€‚è¿˜æ˜¯ä¸€æ ·çš„ä½¿ç”¨check_cookieæ¥åˆ¤æ–­ï¼Œ

â€‹	![image-20221202120844185](../../../images/image-20221202140225964.png)

â€‹	éœ€è¦å¾—åˆ°adminçš„pwdå’Œcookie_hashï¼Œè¿™ä¸¤ä¸ªéƒ½åœ¨æ•°æ®åº“ä¸­ï¼Œå¯ä»¥åˆ©ç”¨å‰å°çš„sqlæ³¨å…¥è·å¾—ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥ç™»å½•adminç”¨æˆ·ã€‚

#### ä»»æ„æ–‡ä»¶è¯»å–

![image-20221202195311948](../../../images/image-20221202195311948-1686141975684.png)

![image-20221202195409112](../../../images/image-20221202195409112-1686141975684.png)



#### ä»»æ„æ–‡ä»¶ä¸Šä¼ 

![image-20221202120844185](../../../images/image-20221202191243192.png)

![image-20221202120844185](../../../images/image-20221202191403061.png)

æ–‡ä»¶è·¯å¾„åªä½œäº†å»é™¤å¤´å°¾ç©ºæ ¼çš„å¤„ç†ï¼Œå­˜åœ¨ç›®å½•ç©¿è¶Šï¼›æ–‡ä»¶å†…å®¹å®é™…ä¸Šæ˜¯è°ƒç”¨äº†stripslashesï¼Œå¹¶æ²¡æœ‰è¿‡æ»¤ã€‚

æµ‹è¯•

![image-20221202120844185](../../../images/image-20221202194248639.png)

<img src="E:\typora img\image-20221202194300861.png" alt="image-20221202194300861" style="zoom:80%;" />





# SeaCMS

ç½‘ç«™æ¶æ„ï¼Œæ— æ¡†æ¶ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹

```php
â”œâ”€admin   # åå°
â”œâ”€css	  # å­˜æ”¾cssæ–‡ä»¶
â”œâ”€files	  # å­˜æ”¾é¡µé¢
â”œâ”€images  # å­˜æ”¾å›¾ç‰‡
â”œâ”€inc	  # å­˜æ”¾ç½‘ç«™é…ç½®ï¼Œæ ¡éªŒï¼Œè¿‡æ»¤æ–‡ä»¶
â”œâ”€install # ç½‘ç«™å®‰è£…
â”œâ”€seacmseditor # ç½‘ç«™ç¼–è¾‘å™¨
â”œâ”€template # ç½‘ç«™æ¨¡æ¿
â””â”€upload   # å­˜æ”¾ä¸Šä¼ æ–‡ä»¶
```

## æŸ¥çœ‹å…¥å£æ–‡ä»¶

æ‰€æœ‰çš„å…¥å£éƒ½æ˜¯é€šè¿‡ä¼ é€’rå‚æ•°æ¥åˆ†å‘è·¯ç”±ï¼Œå¯¹åº”filesç›®å½•ä¸­çš„æ–‡ä»¶

![image-20230525134023397](../../../images/image-20230525134023397-1686141975684.png)

![image-20230525141822013](../../../images/image-20230525141822013-1686141975684.png)



è¿™é‡Œåªç”¨`addslashes`è¿›è¡Œäº†è½¬ä¹‰ï¼Œæ˜æ˜¾è·¯å¾„ç©¿è¶Š+æ–‡ä»¶åŒ…å«

![image-20230525134741282](../../../images/image-20230525134741282-1686141975685.png)

å…¶ä»–æ€è·¯

- å¦‚æœæ˜¯linuxç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥é€šè¿‡`pearcmd.php`æ¥getshell

  > åœ¨7.3åŠä»¥å‰ï¼Œpecl/pearæ˜¯é»˜è®¤å®‰è£…çš„ï¼›åœ¨7.4åŠä»¥åï¼Œéœ€è¦æˆ‘ä»¬åœ¨ç¼–è¯‘PHPçš„æ—¶å€™æŒ‡å®š--with-pearæ‰ä¼šå®‰è£…

- å°è¯•%00æˆªæ–­è·¯å¾„ï¼Œé€ æˆä»»æ„æ–‡ä»¶è¯»å–ï¼Œä¸çŸ¥é“ä¸ºå•¥å¤±è´¥äº†ï¼Œç¯å¢ƒï¼šphp5.3.29ï¼Œ**magic_quotes_gpc**=OFF

- å¦‚æœphpç‰ˆæœ¬å°äº5.2.8ï¼Œlinux éœ€è¦æ–‡ä»¶åé•¿äº 4096ï¼Œwindows éœ€è¦é•¿äº 256ï¼Œè¶…è¿‡éƒ¨åˆ†ä¼šè¢«ä¸¢å¼ƒä»è€Œå®ç°æ–‡ä»¶åŒ…å«ç»•è¿‡åç¼€.phpé™åˆ¶





## æŸ¥çœ‹é…ç½®æ–‡ä»¶

é€šè¿‡installç›®å½•ä¸‹çš„InstallLock.txtæ˜¯å¦å­˜åœ¨æ¥åˆ¤æ–­æ˜¯å¦å®‰è£…ï¼Œå¦‚æœå¯ä»¥åˆ é™¤è¯¥æ–‡ä»¶ï¼Œå°±å¯ä»¥é…åˆå…¥å£æ–‡ä»¶çš„æ–‡ä»¶åŒ…å«æ¼æ´æ¥é‡æ–°å®‰è£…ç½‘ç«™ã€‚

![image-20230525135351792](../../../images/image-20230525135351792-1686141975685.png)

æ•°æ®åº“ç¼–ç ä¸º`utf-8`ï¼Œä¸å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥

![image-20230525135521039](../../../images/image-20230525135521039-1686141975685.png)





## æŸ¥çœ‹èº«ä»½æ ¡éªŒæ–‡ä»¶

![image-20230525140710113](../../../images/image-20230525140710113-1686141975685.png)

å‚ç›´è¶Šæƒï¼Œåªè¦åœ¨cookieä¸­åŠ å…¥userå€¼

![image-20230525140957487](../../../images/image-20230525140957487-1686141975685.png)





## å‰å°

### `about.php`

![image-20230525141923350](../../../images/image-20230525141923350-1686141975685.png)

ä½¿ç”¨`addslashes`æ¥è¿‡æ»¤ï¼Œé€ƒé€¸ä¸äº†å¼•å·ï¼Œæ‰€ä»¥ä¸å­˜åœ¨sqlæ³¨å…¥



### `concat.php`

sqléƒ½ç”¨äº†`addslashes`æ¥è¿‡æ»¤

ä½†æ˜¯å­˜åœ¨xss

![image-20230525142829890](../../../images/image-20230525142829890-1686141975685.png)



![image-20230525142841766](../../../images/image-20230525142841766-1686141975685.png)



![image-20230525143133231](../../../images/image-20230525143133231-1686141975685.png)



![image-20230525143813133](../../../images/image-20230525143813133-1686141975685.png)

```php
cookie:name="><script>alert(/xss/)</script>
```

![image-20230525144008677](../../../images/image-20230525144008677-1686141975686.png)







### `content.php`

å­˜åœ¨æ•°å­—å‹ç»ˆäºå¯ä»¥æ³¨å…¥äº†ï¼Œé…åˆ`mysql_error`è¿›è¡ŒæŠ¥é”™æ³¨å…¥

![image-20230525144109692](../../../images/image-20230525144109692-1686141975686.png)

![image-20230525144251129](../../../images/image-20230525144251129-1686141975686.png)





### `submit.php`

![image-20230525145929543](../../../images/image-20230525145929543-1686141975686.png)

![image-20230525151458927](../../../images/image-20230525151458927-1686141975686.png)

å› ä¸ºéªŒè¯ç æ­£ç¡®åä¹Ÿä¸åˆ·æ–°ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªéªŒè¯ç è¿›è¡Œæ³¨å…¥

![image-20230525151429571](../../../images/image-20230525151429571-1686141975686.png)







å­˜å‚¨xss

è¿‡æ»¤

![image-20230525145800880](../../../images/image-20230525145800880-1686141975686.png)

ä½†æ˜¯è¿˜æ˜¯å¯ä»¥åœ¨nameå¤„ä¿å­˜

è¾“å‡ºç‚¹

![image-20230525145901519](../../../images/image-20230525145901519-1686141975686.png)





## åå°

### åå°ç™»å½•

![image-20230525153016604](../../../images/image-20230525153016604-1686141975686.png)

æ²¡æœ‰è¿‡æ»¤ï¼Œå¯ä»¥ä½¿ç”¨è”åˆæŸ¥è¯¢æ„é€ ä¸´æ—¶ç”¨æˆ·æ•°æ®ç™»å½•,æˆ–è€…æŠ¥é”™æ³¨å…¥æ‹¿åˆ°å¯†ç åè§£å¯†ç™»å½•

åˆ¤æ–­å­—æ®µæ•°

![image-20230525153002742](../../../images/image-20230525153002742-1686141975686.png)

ç¡®å®šç”¨æˆ·åï¼Œå¯†ç å­—æ®µä½ç½®

![image-20230525154135880](../../../images/image-20230525154135880-1686141975687.png)

è”åˆæŸ¥è¯¢ç™»é™†

```php
user=-1'+union+select+1,2,'admin','c4ca4238a0b923820dcc509a6f75849b',5,6,7,8#&password=1&login=yes
```

![image-20230525154322362](../../../images/image-20230525154322362-1686141975687.png)





### æ–‡ä»¶ä¸Šä¼ å¤„

`up.class.php`

ç™½åå•ï¼Œæ–‡ä»¶å¤§å°æ£€æµ‹ï¼Œæ–‡ä»¶æ—¶é—´æˆ³é‡å‘½å,å›¾ç‰‡è£å‰ªç”Ÿæˆç¼©ç•¥å›¾

æ²¡å•¥ç”¨ï¼Œéœ€è¦é…åˆå…¶ä»–æ¼æ´





# DedeCMS

è¿›è¡ŒåŠŸèƒ½ç‚¹å®¡è®¡

## å…¨å±€æ€»è§ˆ

```php
å…¥å£æ–‡ä»¶ä¸»è¦æœ‰ä¸‰ä¸ª
å‰å°
åå°ï¼šdede/
ä¼šå‘˜ï¼šmember/
```

å…¨å±€å‡½æ•°
åœ¨é¡¹ç›®æ ¹ç›®å½•çš„indexæ–‡ä»¶åŒ…å«çš„/include/common.inc.phpä¸­
è¿‡æ»¤çš„ï¼š

æ£€æŸ¥å’Œæ³¨å†Œå¤–éƒ¨æäº¤çš„å˜é‡ï¼Œ`CheckRequest`

![image-20230526102737909](../../../images/image-20230526102737909-1686141975687.png)

æ–‡ä»¶ä¸Šä¼ çš„

![image-20230526102806414](../../../images/image-20230526102806414-1686141975687.png)

åˆ†é¡µå‚æ•°çš„

![image-20230526102852980](../../../images/image-20230526102852980-1686141975687.png)

å‡½æ•°é›†

![image-20230526102920759](../../../images/image-20230526102920759-1686141975687.png)



`include/filter.inc.php`

è¿‡æ»¤ä¸æ–‡æ˜å†…å®¹çš„ğŸ˜…ï¼Œä¸æ˜¯ä¸ºäº†é˜²å¾¡æ¼æ´çš„



## æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ç‚¹

### ` /dede/archives_do.php`

![image-20230525201745708](../../../images/image-20230525201745708-1686141975687.png)



![image-20230525200159854](../../../images/image-20230525200159854-1686141975687.png)

å®é™…ä¸Šæ˜¯è°ƒç”¨äº†`upload.helper.php`ä¸­çš„`AdminUpload`æ–¹æ³•

![image-20230525201545164](../../../images/image-20230525201545164-1686141975687.png)

![image-20230525201700590](../../../images/image-20230525201700590-1686141975687.png)

å¯ä»¥çœ‹åˆ°åªå¯¹æ–‡ä»¶çš„MIMEç±»å‹è¿›è¡Œäº†æ ¡éªŒ,æ²¡æœ‰å¯¹æ–‡ä»¶åç¼€è¿›è¡Œæ ¡éªŒ

å†çœ‹ä¸€ä¸‹å…¨å±€é˜²æŠ¤`uploadsafe.inc.php`

![image-20230525201856657](../../../images/image-20230525201856657-1686141975688.png)

![image-20230525201949967](../../../images/image-20230525201949967-1686141975688.png)

è™½ç„¶æœ‰é»‘åå•ï¼Œä½†æ˜¯é»‘åå•å¯¹ç®¡ç†å‘˜ç”¨æˆ·æ— æ•ˆ

![image-20230525202104709](../../../images/image-20230525202104709-1686141975688.png)

æœ€åç”¨`getimagesize`è¿›è¡Œæ ¡éªŒï¼Œå¯ä»¥æ·»åŠ æ–‡ä»¶å¤´ç»•è¿‡ã€‚

ç»¼ä¸Šæ‰€å±ï¼Œæ˜¯ç®¡ç†å‘˜èº«ä»½ï¼Œåªéœ€è¦ä¿®æ”¹MIMEå’Œæ–‡ä»¶å¤´å³å¯ç»•è¿‡è¿‡æ»¤ã€‚

![image-20230525191610086](../../../images/image-20230525191610086-1686141975688.png)



![image-20230525191553945](../../../images/image-20230525191553945-1686141975688.png)



### `/dede/media_add.php`

![image-20230525205532459](../../../images/image-20230525205532459-1686141975688.png)

è·Ÿä¸Šä¸€ä¸ªå·®ä¸å¤šï¼Œåªæ ¡éªŒMIMEï¼Œä¸æ ¡éªŒåç¼€ï¼Œåªæ˜¯å¤šäº†ä¸€æ­¥åŠ æ°´å°çš„ï¼Œæ‰€ä»¥ä¼ ä¸€ä¸ªphpåç¼€çš„å›¾ç‰‡é©¬

![image-20230525205858924](../../../images/image-20230525205858924-1686141975688.png)





### `/dede/file_manage_control.php`

![image-20230525204329712](../../../images/image-20230525204329712-1686141975689.png)



![image-20230525210840452](../../../images/image-20230525210840452-1686141975688.png)

![image-20230525211553932](../../../images/image-20230525211553932-1686141975689.png)

æ²¡æœ‰å¯¹å†…å®¹è¿›è¡Œè¿‡æ»¤ï¼Œè¿™é‡Œå¯ä»¥å†™ğŸ



## URLé‡å®šå‘

`plus/download.php`

![image-20230526100708534](../../../images/image-20230526100708534-1686141975688.png)

![image-20230526100724469](../../../images/image-20230526100724469-1686141975689.png)

![image-20230526101319599](../../../images/image-20230526101319599-1686141975690.png)

`$linkinfo`å‹æ ¹ä¸å­˜åœ¨ï¼Œæ²¡æœ‰è¿‡æ»¤ï¼Œå¯¹urlå…ˆè¿›è¡Œbase64åŠ å¯†ï¼Œå†è¿›è¡ŒurlåŠ å¯†å³å¯

![image-20230526101138188](../../../images/image-20230526101138188-1686141975689.png)





## ä¼šå‘˜ä»»æ„å¯†ç ä¿®æ”¹

å…ˆçœ‹ä¸€ä¸‹ä¼šå‘˜ä¸­å¿ƒçš„é€»è¾‘

`member/index.php`

æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œç™»å½•åˆ™è¿›å…¥ä¼šå‘˜ä¸ªäººä¸­å¿ƒ

`member/index_do.php`

ä¼šå‘˜æ“ä½œä¸`$fmdo`å‚æ•°åŒ¹é…

é‡ç½®å¯†ç 

```php
index_do.php?fmdo=user&dopost=xxx
```

é‡ç½®å¯†ç é€»è¾‘åœ¨`resetpassword.php`ä¸­,å¤§è‡´é€»è¾‘å¦‚ä¸‹

```php
if($dopost == "")
{
  include(dirname(__FILE__)."/templets/resetpassword.htm");
}
elseif($dopost == "getpwd")
{
  	// æ‰¾å›å¯†ç ç¬¬ä¸€æ­¥
}
else if($dopost == "safequestion")
{
  	// å¯†ç é—®é¢˜åˆ¤æ–­
}
else if($dopost == "getpasswd")
{
  	// æ‰¾å›å¯†ç ç¬¬äºŒæ­¥
}
```

é‡ç‚¹å…³æ³¨å¯†ç é—®é¢˜åˆ¤æ–­

![image-20230526123219865](../../../images/image-20230526123219865-1686141975689.png)

ä½¿ç”¨äº†å¼±æ¯”è¾ƒï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®å¯†ç é—®é¢˜ï¼Œé»˜è®¤å€¼å¦‚ä¸‹



![image-20230526123041472](../../../images/image-20230526123041472-1686141975689.png)

æ‰€ä»¥å¯ä»¥æ„é€ `safequestion=0.0&safeanswer=`æ¥è¿›å…¥è¯¥ifè¯­å¥

è·Ÿè¿› snï¼Œæœ€ç»ˆæ˜¯é‡å®šå‘åˆ°ä¿®æ”¹å¯†ç é¡µé¢

![image-20230526123510601](../../../images/image-20230526123510601-1686141975689.png)



## ä»»æ„ç”¨æˆ·ç™»å½•

çœ‹ä¸€ä¸‹æ€ä¹ˆå¤„ç†çš„

`member/config.php`

![image-20230526130641724](../../../images/image-20230526130641724-1686141975689.png)

è·Ÿè¿›

![image-20230526130848007](../../../images/image-20230526130848007-1686141975689.png)

![image-20230526132740089](../../../images/image-20230526132740089-1686141975689.png)

å¯¹å¾—åˆ°çš„`M_ID`åšäº†`intval`å¤„ç†ï¼Œæœ€åæ ¹æ®`M_ID`çš„å€¼ä»æ•°æ®åº“ä¸­å–å‡ºå¯¹åº”ç”¨æˆ·

è·Ÿè¿›`getnum`

![image-20230526132102568](../../../images/image-20230526132102568-1686141975689.png)

è·Ÿè¿›`getcookie`

![image-20230526131125230](../../../images/image-20230526131125230-1686141975689.png)

ä¸¤ä¸ªIFï¼Œç¬¬ä¸€ä¸ªifåˆ¤æ–­Cookieä¸­çš„DedeUserIDå’ŒDedeUserID__ckMD5,å¦‚æœéƒ½å­˜åœ¨è¿›å…¥ç¬¬äºŒä¸ªifï¼Œæ ¡éªŒcookieæœ‰æ•ˆæ€§ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡åŠ ç›å†åŠ å¯†çš„æ–¹å¼ï¼Œæ‰€ä»¥æŒ‰ç†è¯´æ˜¯æ— æ³•ä¼ªé€ cookieçš„ã€‚

ä½†æ˜¯å¯ä»¥ä»`/member/index.php`å¯ä»¥æ¥è·å–è¿™ä¸ªåŠ å¯†åçš„å€¼

æœç´¢`getcookie`å¾—åˆ°

![image-20230526131657609](../../../images/image-20230526131657609-1686141975689.png)

è·Ÿè¸ª`$last_vid`

![image-20230526132259147](../../../images/image-20230526132259147-1686141975690.png)

å¦‚æœ`$last_vid`ä¸ºç©ºï¼Œé‚£ä¹ˆå°†`$uid`èµ‹å€¼ç»™`$last_vid`ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™`PutCookie`å‡½æ•°

è·Ÿè¿›`PutCookie`å‡½æ•°

![image-20230526132158862](../../../images/image-20230526132158862-1686141975690.png)

å¯ä»¥çœ‹åˆ°è·Ÿç™»å½•çš„`getcookie`åŠ å¯†æ–¹å¼ä¸€æ ·ã€‚

æ€»ç»“ä¸€ä¸‹ï¼š

ç™»å½•

```php
ç”¨æˆ·çš„èº«ä»½ç”±DedeUserIDçš„å€¼æ¥å†³å®š

æ ¡éªŒï¼šDedeUserID__ckMd5çš„å€¼å’Œmd5($cfg_cookie_encode.DedeUserID)
```

è®¿é—®`member/index.php?uid=xx`

```php
last_vid=uid

last_vid__ckMd5=md5($cfg_cookie_encode.uid)
```

æ‰€ä»¥è®©

```
DedeUserID=last_vid=uid
DedeUserID__ckMd5=last_vid__ckMd5
```

å°±å¯ä»¥ç»•è¿‡getcookieçš„æ ¡éªŒï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯`uid`æŒ‡çš„æ˜¯ç”¨æˆ·çš„`userid`ï¼Œ`DedeUserID`æŒ‡çš„æ˜¯ç”¨æˆ·çš„`mid`ï¼Œæ‰€ä»¥è¦è®©`uid`ä¸º`mid`æ‰å¯ä»¥ä¼ªé€ èº«ä»½

![image-20230526134001725](../../../images/image-20230526134001725-1686141975691.png)

è¿˜è®°å¾—ä¸Šé¢çš„å¤„ç†å—ï¼Ÿ

![image-20230526134147020](../../../images/image-20230526134147020-1686141975690.png)

æ‰€ä»¥åªéœ€è¦æ„é€ ä¸€ä¸ªå«æœ‰æ•°å­—1çš„å­—ç¬¦ä¸²å°±å¯ä»¥ä¼ªé€ adminçš„èº«ä»½ã€‚

æ³¨å†Œä¸€ä¸ªç”¨æˆ·åä¸º1adminçš„ç”¨æˆ·

![image-20230526125711799](../../../images/image-20230526125711799-1686141975690.png)

```
DedeUserID=last_vid=uid
DedeUserID__ckMd5=last_vid__ckMd5
```

![image-20230526125702071](../../../images/image-20230526125702071-1686141975690.png)





# ThinkPHP

## å®‰è£…

```powershell
composer create-project --prefer-dist topthink/think=5.0.10 tp5.0.10
```

å°† [composer](https://so.csdn.net/so/search?q=composer&spm=1001.2101.3001.7020).json æ–‡ä»¶çš„ require å­—æ®µè®¾ç½®æˆå¦‚ä¸‹

```php
"require": {
    "php": ">=5.4.0",
    "topthink/framework": "5.0.10"
}
```

æ›´æ–°

```powershell
composer update
```

å°†å…¶æ”¾ç½®åˆ°ç½‘ç«™ç›®å½•ä¸‹ï¼Œè®¿é—®http://127.0.0.1/tp5.0.10/public/

![image-20230529155309821](../../../images/image-20230529155309821-1686141975690.png)



## æ¦‚è§ˆ

æ¨èé˜…è¯»https://www.cnblogs.com/yokan/p/16102644.html

### è·¯ç”±å’Œå‚æ•°ä¼ é€’

```php
http://servername/index.php/æ¨¡å—/æ§åˆ¶å™¨/æ“ä½œ/[å‚æ•°å/å‚æ•°å€¼...] # pathinfoæ¨¡å¼

http://servername/index.php?s=/index/Index/index    # å…¼å®¹æ–¹å¼
```

```php
?name=213
/name/123
```

å¦‚æ§åˆ¶å™¨Indexï¼š`application/index/controller/Index.php`

![image-20230531232416306](../../../images/image-20230531232416306.png)

```php
http://127.0.0.1/tp5.0.10/public/index.php/index/Index/hello?name=world
http://127.0.0.1/tp5.0.10/public/index.php/index/Index/hello/name/world

http://127.0.0.1/tp5.0.10/public/index.php?s=/index/Index/hello/name/world
http://127.0.0.1/tp5.0.10/public/index.php?s=/index/Index/hello&name=world
```





## Requestç±»ä»»æ„è°ƒç”¨__constructæ–¹æ³•å¯¼è‡´çš„rce

### æ¦‚è¿°

Requestæ ¸å¿ƒç±»**$method** æ¥è‡ªå¯æ§çš„ **$_POST** æ•°ç»„ï¼Œè€Œä¸”åœ¨è·å–ä¹‹åæ²¡æœ‰è¿›è¡Œä»»ä½•æ£€æŸ¥ï¼Œç›´æ¥æŠŠå®ƒä½œä¸º **Request** ç±»çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼ŒåŒæ—¶ï¼Œè¯¥æ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯å¯æ§æ•°æ® **$_POST** ã€‚å¯¼è‡´å¯ä»¥éšæ„è°ƒç”¨ **Request** ç±»çš„éƒ¨åˆ†æ–¹æ³•

> **è¿‡ç¨‹ï¼š**
>
> è®©methodç­‰äº `__construct`é­”æœ¯æ–¹æ³•ï¼Œç„¶åé‡Œé¢çš„ `foreach`å‡½æ•°é€ æˆå˜é‡è¦†ç›–ã€‚ç„¶åé€šè¿‡**Request** ç±»ä¸­çš„ `param`æ–¹æ³•æœ€ç»ˆåˆè°ƒç”¨äº†`filterValue`æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•ä¸­å°±å­˜åœ¨å¯åˆ©ç”¨çš„ **call_user_func** å‡½æ•°ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤

> **Request** ç±»ä¸­çš„ `paramã€routeã€getã€postã€putã€deleteã€patchã€requestã€sessionã€serverã€envã€cookieã€input` æ–¹æ³•å‡è°ƒç”¨äº† **filterValue** æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•ä¸­å°±å­˜åœ¨å¯åˆ©ç”¨çš„ **call_user_func** å‡½æ•°

ä»¥5.0.10ç‰ˆæœ¬ä¸ºä¾‹

payload

```http
http://127.0.0.1/tp5.0.10/public/index.php

# post
_method=__construct&filter=system&cmd=whoami
```

![image-20230531225820851](../../../images/image-20230531225820851.png)



### è°ƒè¯•

ç¬¬ä¸€ä¸ªæ–­ç‚¹ä¸‹åœ¨`thinkphp/libary/think/App.php`æ–‡ä»¶ï¼Œè°ƒç”¨`routeCheck`è¿›è¡Œè°ƒåº¦è§£æè¿™é‡Œ

![image-20230531221156861](../../../images/image-20230531221156861.png)

è·Ÿè¿›`routeCheck`

![image-20230531221218359](../../../images/image-20230531221218359.png)

è·Ÿè¿›`check`

![image-20230531221233596](../../../images/image-20230531221233596.png)

è·Ÿè¿›`method`

![image-20230531221259178](../../../images/image-20230531221259178.png)

`var_method`åœ¨`application/config.php`ä¸­

![image-20230531222320838](../../../images/image-20230531222320838.png)

æ‰€ä»¥è¿™é‡Œå¯ä»¥æ§åˆ¶`method`å˜é‡ï¼Œä»è€Œä»»æ„è°ƒç”¨Requestç±»çš„æ–¹æ³•ã€‚

å¦‚æœè°ƒç”¨`__construct`æ–¹æ³•

![image-20230531221707200](../../../images/image-20230531221707200.png)

å­˜åœ¨ä¸€ä¸ª`foreach`å¾ªç¯ï¼Œå¦‚æœä¼ å…¥çš„`options`æ•°ç»„çš„é”®åä¸ºè¯¥ç±»çš„å±æ€§ï¼Œå°±ç”¨é”®å€¼è¦†ç›–è¯¥å±æ€§çš„å€¼ã€‚

![image-20230531222852250](../../../images/image-20230531222852250.png)

ç»§ç»­å¾€ä¸‹

åœ¨`App::run()`æ–¹æ³•é‡Œé¢ï¼Œå¦‚æœæˆ‘ä»¬å¼€å¯äº†debugæ¨¡å¼ï¼Œåˆ™ä¼šè°ƒç”¨`Request::param()`æ–¹æ³•ï¼š

![image-20230531223011915](../../../images/image-20230531223011915.png)

å°±ç®—æ²¡æœ‰å¼€å¯debugæ¨¡å¼ï¼Œä¸‹é¢çš„execæ–¹æ³•ä¹Ÿä¼šè°ƒç”¨

![image-20230531230604547](../../../images/image-20230531230604547.png)

![image-20230531220640414](../../../images/image-20230531220640414.png)

è·Ÿè¿›`Request::param()`æ–¹æ³•

å°†è·å–åˆ°çš„postå‚æ•°ç”¨`array_merge`ä¸getæ–¹å¼çš„å‚æ•°è¿›è¡Œåˆå¹¶

![image-20230531225110758](../../../images/image-20230531225110758.png)

æœ€åå°†å…¶ä¼ å…¥`input`ä¸­

![image-20230531224212939](../../../images/image-20230531224212939.png)

è·Ÿè¿›`Request::input()`,`array_walk_recursive`  å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªæˆå‘˜é€’å½’åœ°åº”ç”¨ç”¨æˆ·å‡½æ•°

![image-20230531224435122](../../../images/image-20230531224435122.png)

ç„¶å`filterValue`æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†`call_user_func`é€ æˆä»»æ„å‘½ä»¤æ‰§è¡Œ

![image-20230531223158698](../../../images/image-20230531223158698.png)

### å…³é”®ç‚¹æ€»ç»“

Fromï¼šä¸ƒæœˆç«å¸ˆå‚…çš„ä¸€å¼ æµç¨‹å›¾

![img](../../../images/1964477-20220405155310200-1040131440.png)

### å…¶ä»–ç‰ˆæœ¬

æµç¨‹å¤§åŒå°å¼‚

payloadæ€»ç»“ï¼šhttps://y4er.com/posts/thinkphp5-rce/#thinkphp5-method%E4%BB%BB%E6%84%8F%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E5%AF%BC%E8%87%B4rce





