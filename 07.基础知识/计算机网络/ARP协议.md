---
title: ARP协议
date: 2023/6/1 16:00:25
categories:
- 计算机基础
tags:
- ARP协议
---



## ARP协议是什么

​	ARP 协议是地址解析协议。它的作用是，通过IP地址（身份证号），问出MAC地址（名字）。

​	比如说，一个网络，有A、B、C 和 D四个设备，还有一个特殊的设备，它是路由器。每个设备有 IP 地址和 MAC 地址。

![img](../images/1658199491_62d61dc3accbdb9a8b4c3-1694328189527.jpg!small)
	假设，设备A 需要发送数据包给设备C，设备A的应用程序只知道要发送数据给10.0.2.6这个ip，但是发不出去。

这是因为，IP地址类似身份证号，在全国范围内，它很好用，但在家庭范围内不灵。MAC类似名字，在全国范围内不灵，但家庭内部，还得靠这个。

​	同样，局域网内部通信，也就是通过普通二层交换机通信，IP(身份证号)不灵，得依靠MAC(名字)。A必须知道10.0.2.6的MAC地址，才能将数据包发送出去。然而，设备A怎么知道设备C的MAC呢？这就要依靠 ARP 协议。



## ARP协议如何实现

​	设备A发送一个广播包，它就是ARP 包，问所有设备： 10.0.2.6(身份证号)是谁的？或许有善于思考的人会问，此时A不知道其他机器的mac地址，怎么发数据包？我回答：广播包是普发，既然普发，当然无需知道接收方的mac地址。

![img](../images/1658199518_62d61ddead52e7492752c-1694328193352.jpg!small)
	其他设备都不予理睬，设备C知道自己的IP是10.0.2.6，所以，它立即做出回应。

​	正常情况下，其他的设备都默不作声，只有设备C，它会发出应答包。善于思考的人此时又会问：C不知道A的mac地址，怎么回应？错：A发送的广播包中带有自己的mac地址，所以，C此时已经有了A的mac地址。回应包就像一张身份证：一行是身份证号ip，下一行是姓名mac。就这样，设备A通过询问，拿到了设备C的MAC，二者就可以在局域网中进行通信了。

![img](../images/1658199555_62d61e035ce70a9b1f624-1694328196273.jpg!small)
	这里就出现另一个问题：是不是每发送一次都得经过广播 -> 封装 ARP 响应 -> 返回给主机这一系列流程呢？

​	答案是：ARP表

​	主机通过把第一次 ARP 获取到的 MAC 地址作为 IP 对 MAC 的映射关系到一个 ARP 缓存表中，下一次再向这个地址发送数据报时就不再需要重新发送 ARP 请求了，而是直接使用这个缓存表中的 MAC 地址进行数据报的发送。





## ARP数据包

实验环境：宿主机window10，虚拟机kaii（net连接）

工具：wireshark

选择捕获VMnet8网卡。

在宿主机上`ping 192.168.244.128` （ping 虚拟机ip地址），过滤ARP协议得到

![image-20220929154825833](../images/image-20220929154825833-1694328200254.png)

可以看到info的信息其实就告诉我们了ARP协议是用来干嘛的。



数据包内容，以ARP请求为例：

![image-20220929155056878](../images/image-20220929155056878-1694328203114.png)

1. 第一帧描述了ARP数据包的长度，时间，类型等信息。

   ![image-20220929155056878](../images/image-20220929155151496.png)

2. 第二帧描述了源mac地址和目标mac地址

   其中目的地址`ff:ff:ff:ff:ff:ff`为广播地址

   ![image-20220929155056878](../images/image-20220929155258245.png)

3. 第三帧

   > 引用图片

   ![1657258276_62c7c1240a8a324d48f7b.png!small](../images/1657258276_62c7c1240a8a324d48f7b-1694328215300.png!small)

ARP响应包主要不同点就在于ARP数据包类型以及源，目标地址。

![image-20220929155642126](../images/image-20220929155642126-1694328218908.png)





## ARP协议探测主机

> 因为ARP的工作流程，所以可以用来探测主机。

使用netdiscover工具进行探测

```shell
netdiscover -r 192.168.244.1/24
```

下图为另一台虚拟机ubuntu的ip地址

![image-20220929150651695](../images/image-20220929150651695-1694328222991.png)

下图为命令执行结果

![image-20220929150631230](../images/image-20220929150631230-1694328225340.png)

192.168.244.1为本机

192.168.244.2为VM网关

192.168.244.129为同一局域网下的主机

192.168.244.254为VM？



## ARP攻击

### 欺骗攻击

#### 产生原因

ARP的特性

> 设备就算没有主动去询问（发广播包），也会接收别人主动发来的身份诊卡（ARP回应包）。
>
> 并且接收时不会去判断真假，而是直接保存到ARP表中。



#### 欺骗主机

Victim：虚拟机ububtu正常联网

![image-20220929151256047](../images/image-20220929151256047-1694328229283.png)

hacker：kali机使用arpspoof工具进行ARP欺骗攻击

```shell
arpspoof -i 网卡名 -t  目标主机  路由器
```

![image-20220929151906826](../images/image-20220929151906826-1694328232862.png)

命令的结果就是让Victim的ARP表中存储的路由器mac地址变为hacker的mac地址，即发送的数据包会到hacker主机，而不是到路由器。

从下图可以看到victim无法访问网站，并且通过命令`arp -a`查看ARP表会发现VM网关（192.168.244.2）的mac地址和hacker的mac地址是一样的，所以ARP欺骗攻击成功了。

![image-20220929151847725](../images/image-20220929151847725-1694328235790.png)



#### 中间人攻击--欺骗网关和主机

​	在上面的基础上，hacker还可以再对路由器进行ARP欺骗攻击，让路由器中Victim的ip所对应的MAC地址变为hacker的MAC地址，这样当Victim发送数据包的时候就会先发送到hacker手上，hacker可以把数据包再给路由器，当路由器收到响应的数据包时，就会转发给hacker，这样hacker就能够监控并更改Victim的通信了。

![img](../images/1658199907_62d61f63394a1350fb977-1694328238721.jpg!small)

### 防御

- 绑定mac地址
- 使用静态arp缓存表



## 参考文章

[ARP协议](https://www.freebuf.com/vuls/338603.html)

[ARP欺骗](https://www.freebuf.com/articles/network/339512.html)