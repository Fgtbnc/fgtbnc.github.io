![image-20241126222950647](D:/source/images/image-20241126222950647.png)

# 支付流程

选择商品和数量-选择支付及配送方式-生成订单编号-订单支付选择（是否支付）-完成支付



# 商品价格

- 整型溢出

  ```
  超出最大值后重新开始计数
  ```

- 负数

  ```
  正常的逻辑是用户购买商品，然后价格累加得到一个总价进行扣款。这个时候就会产生逻辑问题：如果说用户购买的商品价格是负数了，那么计算的总数就是负数。反过来钱给用户
  ```

- 四舍五入

  ```
  以充值为例，余额值一般保存到分为止，那么如果我充值
  0.001元也就是1厘，一般开发会在前端判断我们的数字，或者将最后一位四舍
  五入，使用支付宝充值是直接报错的，因为第三方一般只支持到分。
  那我们如果充值0.019呢，由于支付宝只判断到分，所以导致只能支付0.01，
  而由于我们支付成功，前端会将9四舍五入，直接变成0.02，所以等于直接半价
  充值。（这个漏洞京东也是有的，不过后来修复了。
  ```

  

# 营销折扣

- 积分兑换场景

  > 积分抵钱是如何换算的？

  ```php
  # 假设1比2换算，1积分算2元
  100 - 积分 = 100 - 积分
  100 - -积分 = 100 + 积分
  100 - 积分*10 = (100 - 积分) *10
  
  100 - (2*积分) = 100 - (2*积分)
  100 - (2* (积分-积分-1) ) = 100 + 2
  ```

- 优惠券场景

  - 并发领取

  - 盗用

    ```
    研究优惠卷的编号规律，使用没领的
    水平越权，盗用别人的
    ```

  - 重复使用

    ```
    使用优惠卷的数据包进行并发，创建多个使用了优惠券的订单
    
    订单关闭返还优惠券：使用优惠卷创建一个待支付订单，然后关闭这个待支付订单，这时候订单关闭会返还优惠卷，如果这个关闭的订单可以重新变为待支付订单（就是之前使用优惠券的金额）那么就存在这个漏洞
    ```

- 每日签到场景

  - 修改当前设备时间
  - 并发签到
  - 修改数据包时间参数

- 签约低价场景

  > 场景：就是用户第一个月会员便宜，但是会在签约对象那里开通自动续费功能

  - 多次签约低价

    ```
    漏洞危害：原本只能低价开通一个月，但是通过这个漏洞能够低价开通不止一个月
    漏洞原理：签约的对象有多个，比如微信和支付宝，让这两个都停留在签约界面，然后先完成其中一个签约再取消签约，再到另一个完成签约，因为第一个签约被取消掉了所以服务端认为另一个签约还是第一次签约，从而低价开通了两个月
    ```

    

# 订单判断

- 并发支付

  ```
  购买成功之后，继续重放请求，可以让购买的商品一直增加。购买成功之后，会有一个银行对商户网站跳转的过程，如果反复进行操作，有几率会导致商品反复购买和增加，但是不需要付更多的钱。
  ```

- 替换支付

  ```
  同时向服务器发起二次支付请求一个多一个少，支付金额少的，然后支付之后进行替换，告知服务器订单支付完成，并且过程可以反复的回放。
  ```

- 订单商品修改

  ```
  把商品放入购物车点击下单支付，会跳转到微信，支付宝等第三方支付平台。这个时候还可以继续在购物车中加入商品，支付结束之后，商家发放的商品是现在的购物车里面的东西。
  ```

  

# 支付接口

- 支付接口修改

- 支付接口密钥Key

  ```
  暴力破解
  秘钥泄漏
  ```

> 8.欺诈:需要两个收款人，一个是正常的商家，一个是伪造的商家
>
> 9.单位替换：产生在paypal类似的国际支付的场景。



# 支付安全修复

1、在后端检查订单的每一个值，包括支付状态；
2、校验价格、数量参数，比如产品数量只能为整数，并限制最大购买数量 ；
3、与第三方支付平台检查，实际支付的金额是否与订单金额一致；
4、如给用户退款，要使用原路、原订单退回。如：退押金，按用户原支付订单原路退回；
5、加密、解密、数字签名及验证，这个可以有效避免数据修改，重放攻击中的各种问题；
6、金额超过指定值，进行人工审核等。

